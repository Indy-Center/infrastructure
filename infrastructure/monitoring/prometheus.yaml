apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: kube-prometheus-stack
  namespace: monitoring
spec:
  repo: https://prometheus-community.github.io/helm-charts
  chart: kube-prometheus-stack
  version: "69.2.0"
  targetNamespace: monitoring
  valuesContent: |-
    prometheus:
      ingress:
        enabled: false
      prometheusSpec:
        nodeSelector:
          node.kubernetes.io/role: ops
        tolerations:
          - key: "node.kubernetes.io/role"
            operator: "Equal"
            value: "ops"
            effect: "NoSchedule"

    grafana:
      ingress:
        enabled: false
      nodeSelector:
        node.kubernetes.io/role: ops
      tolerations:
        - key: "node.kubernetes.io/role"
          operator: "Equal"
          value: "ops"
          effect: "NoSchedule"
      envFromSecret: grafana-oauth
      grafana.ini:
        server:
          root_url: https://metrics.zid-internal.com
          protocol: http
        auth.github:
          enabled: true
          allow_sign_up: true
          scopes: read:org,user:email,repo
          auth_url: https://github.com/login/oauth/authorize
          token_url: https://github.com/login/oauth/access_token
          api_url: https://api.github.com/user
          allowed_organizations: indy-center
          client_id: ${GF_AUTH_GITHUB_CLIENT_ID}
          client_secret: ${GF_AUTH_GITHUB_CLIENT_SECRET}
          role_attribute_path: contains(groups[*], '@Indy-Center/devops') && 'GrafanaAdmin' || contains(groups[*], '@Indy-Center/developers') && 'Editor' || 'None'